# 延迟参考数据 - 可靠数据源整理

本文档整理了可靠数据源的硬件和软件典型延迟数据，这些数据是高性能系统设计的重要参考。

---

## 时钟周期计算（3GHz CPU）

- **3GHz CPU** = 3,000,000,000 Hz
- **1个时钟周期** = 1/3,000,000,000 秒 = **0.333纳秒**

---

## 延迟层次表（3GHz CPU）

| 操作/组件 | 典型范围 | 周期数（最小值） | 备注 |
|---------|---------|----------------|------|
| **━━━ 纳秒级（ns）━━━** | | | |
| **寄存器操作** | < 0.33ns | < 1 | 最快的基础运算 |
| **L1 缓存命中** | ~1ns | ~3 | ⭐ 最快缓存 |
| **L2 缓存命中** | ~4ns | ~12 | 核心私有缓存 |
| **L3 缓存命中** | 最多 ~12.7ns | 最多 ~38 | 共享缓存 |
| **C 函数直接调用** | 5-10ns | 15-30 | 非虚函数，编译器可优化 |
| **C++ 虚函数调用** | 10-20ns | 30-60 | 需要查 vtable |
| **Disruptor Min Latency** | **29ns** | **~87** | LMAX Disruptor最小延迟 |
| **Disruptor Mean Latency** | **52ns** | **~156** | LMAX Disruptor平均延迟 |
| **主内存读取（本地）** | ~65ns | ~195 | DDR4 随机读取 |
| **主内存读取（远程 NUMA）** | ~105ns | ~315 | 跨 socket 访问 |
| **Disruptor 99% Latency** | **128ns** | **~384** | 99%观测值小于此值 |
| **━━━ 微秒级（μs）━━━** | | | |
| **Aeron IPC** | **~0.25μs** | **~750** | 共享内存进程间通信 |
| **RDMA (高端网卡)** | < 1μs | < 3K | 理想条件下，某些高性能网卡可达 |
| **线程上下文切换（直接开销）** | ~0.67μs | ~2K | 仅切换开销，不包括缓存失效 |
| **C++ 异常抛出+捕获** | **1.7-3.3μs** | **5K-10K** | ⚠️ 异常处理开销巨大，应避免在热路径使用 |
| **RDMA (InfiniBand)** | **~2.3μs** | **~6.9K** | ⭐ 最低网络延迟 |
| **RDMA (RoCE)** | **~3.1μs** | **~9.3K** | 基于以太网的RDMA |
| **线程上下文切换（总开销）** | 3.3μs - 333μs | 10K - 1M | 缓存失效可能导致巨大延迟 |
| **UDP (loopback)** | 5-10μs | 15K-30K | 标准UDP loopback，不经过物理网络 |
| **Cilium eBPF 转发（同节点）** | **5-50μs** | **15K-150K** | 绕过内核，用户空间处理 |
| **Aeron UDP (loopback)** | **~10μs** | **~30K** | 优化的UDP实现，同一台机器上 |
| **TCP (loopback)** | 10-20μs | 30K-60K | 标准TCP loopback，包含连接管理开销 |
| **NVMe SSD 随机读取（高端）** | **~20μs** | **~60K** | PCIe 4.0, 低延迟型号 |
| **NVMe SSD 随机读取** | 20-100μs | 60K-300K | 高端型号可低至 20μs |
| **UDP (同机房)** | 50-150μs | 150K-450K | 同机房网络，经过物理网卡和交换机 |
| **传统 TCP/IP (同机房)** | **100-200μs** | **300K-600K** | 需要经过物理网卡、交换机等网络设备 |
| **SATA SSD 随机读取** | 0.1-0.5ms | 300K-1.5M | 典型访问延迟 |
| **传统 TCP/IP (跨网络)** | 200-500μs | 600K-1.5M | 包含路由、拥塞控制等开销 |
| **━━━ 毫秒级（ms）━━━** | | | |
| **Cilium eBPF 转发（跨AZ）** | **~0.55ms RTT** | **~1.65M** | 跨可用区往返延迟 |
| **HDD (15000 RPM)** | **~2ms** | **~6M** | 企业级硬盘，平均延迟 |
| **HDD (7200 RPM)** | **8-15ms** | **24M-45M** | ⚠️ 最慢，寻道时间 + 旋转延迟 |

**说明**：
- **AZ = 可用区（Availability Zone）**：云服务商在同一地域内的独立数据中心。跨AZ延迟高于同AZ内。
- 数据源优先级：**参考3=参考1=参考4 > 参考2 > 参考5 > 参考6/参考7**
- 实际延迟会因硬件配置、操作系统、网络环境、系统负载、消息大小等因素而有所差异

---

## 参考1：Disruptor 软件延迟数据

**数据来源**: [LMAX Disruptor 官方文档](https://lmax-exchange.github.io/disruptor/)

### Disruptor vs ArrayBlockingQueue 延迟对比（Three-Stage Pipeline 测试）

| 指标 | ArrayBlockingQueue | Disruptor | 改进倍数 | 说明 |
|------|-------------------|-----------|---------|------|
| **Min Latency** | **145ns** | **29ns** | **5.0x** | 最小延迟（单跳） |
| **Mean Latency** | **32,757ns** | **52ns** | **630x** | 平均延迟（单跳） |
| **99% Latency** | **2,097,152ns** | **128ns** | **16,384x** | 99%观测值小于此值 |
| **99.99% Latency** | **4,194,304ns** | **8,192ns** | **512x** | 99.99%观测值小于此值 |
| **Max Latency** | **5,069,086ns** | **175,567ns** | **29x** | 最大延迟（极端情况） |

**测试环境**：2.2GHz Core i7-2720QM, Java 1.6.0_25, Ubuntu 11.04  
**技术论文**: [Disruptor: High Performance Alternative to Bounded Queues](https://lmax-exchange.github.io/disruptor/disruptor.html)

---

## 参考2：CPU 操作完整代价表

**数据来源**: [ithare.com](http://ithare.com/) - "Not all CPU operations are created equal" 图表

以下数据按延迟从低到高排序：

| 操作 | 周期数范围 | 纳秒 @ 3GHz | 类别 | 说明 |
|------|-----------|------------|------|------|
| **━━━ < 10 周期 ━━━** | | | | |
| **寄存器-寄存器操作** (ADD, OR 等) | **< 1** | **< 0.33ns** | CPU | 最快的基础运算 |
| **内存写入** | **~1** | **~0.33ns** | 内存 | 写入到存储缓冲 |
| **"正确"分支** (if 预测正确) | **1-2** | **0.33-0.67ns** | 分支 | 分支预测命中，几乎无开销 |
| **整数/浮点/向量加法** | **1-3** | **0.33-1ns** | CPU | SIMD 操作 |
| **整数/浮点/向量乘法** | **1-7** | **0.33-2.3ns** | CPU | 乘法比加法慢 |
| **L1 缓存读取** | **4** | **~1.3ns** | 缓存 | 核心私有缓存 |
| **━━━ 10-100 周期 ━━━** | | | | |
| **"错误"分支** (分支预测失败) | **10-20** | **3.3-6.7ns** | 分支 | 需要刷新流水线，重新取指 |
| **浮点除法** | **10-40** | **3.3-13ns** | CPU | 除法比乘法慢得多 |
| **128位向量除法** | **10-70** | **3.3-23ns** | CPU | SIMD 除法更慢 |
| **L2 缓存读取** | **10-12** | **3.3-4ns** | 缓存 | 核心私有缓存 |
| **整数除法** | **15-40** | **5-13ns** | CPU | 整数除法也较慢 |
| **C 函数直接调用** | **15-30** | **5-10ns** | 函数 | 非虚函数，编译器可优化 |
| **C 函数间接调用** | **20-50** | **6.7-17ns** | 函数 | 函数指针调用 |
| **C++ 虚函数调用** | **30-60** | **10-20ns** | 函数 | 需要查 vtable，比直接调用慢 2-3 倍 |
| **L3 缓存读取** | **30-70** | **10-23ns** | 缓存 | 共享缓存，延迟可变 |
| **━━━ 100-1000 周期 ━━━** | | | | |
| **主内存读取** (本地) | **100-150** | **33-50ns** | 内存 | DDR4 随机读取 |
| **NUMA: 不同 socket L3 读取** | **100-300** | **33-100ns** | 内存 | 跨 socket 访问 |
| **分配+释放对** (小对象) | **200-500** | **67-167ns** | 内存 | malloc/free 或 new/delete |
| **NUMA: 不同 socket 主内存读取** | **300-500** | **100-167ns** | 内存 | 跨 socket 主内存访问 |
| **━━━ 1000-10000 周期 ━━━** | | | | |
| **内核调用** (系统调用) | **1,000-1,500** | **0.33-0.5μs** | 系统 | 用户态到内核态切换 |
| **线程上下文切换** (直接开销) | **~2,000** | **~0.67μs** | 系统 | 仅切换开销，不包括缓存失效 |
| **C++ 异常抛出+捕获** | **5,000-10,000** | **1.7-3.3μs** | C++ | 异常处理开销巨大，应避免在热路径使用 |
| **━━━ > 10000 周期 ━━━** | | | | |
| **线程上下文切换** (总开销，含缓存失效) | **10,000 - 1,000,000** | **3.3μs - 333μs** | 系统 | 缓存失效可能导致巨大延迟 |

---

## 参考3：硬件延迟数据（Sandy Bridge 架构）

**数据来源**: [Martin Thompson 的 Mechanical Sympathy 博客](https://mechanical-sympathy.blogspot.com/)

以下数据来自 Martin Thompson 对 **Intel Sandy Bridge** 架构的详细分析（基于实际测试和架构文档）：

### CPU 内部存储层次

| 组件 | 大小/容量 | 延迟（周期） | 延迟（ns @ 3GHz） | 说明 |
|------|---------|-------------|-----------------|------|
| **寄存器** | 160 整数 + 144 浮点 | **1 周期** | **~0.33ns** | 最快，单周期访问，编译器分配局部变量 |
| **L1 数据缓存** | 32KB | **3 周期** | **~1ns** | 核心私有，分离的数据和指令缓存 |
| **L1 指令缓存** | 32KB | **3 周期** | **~1ns** | 核心私有 |
| **L2 缓存** | 256KB | **12 周期** | **~4ns** | 核心私有，统一的数据和指令缓存 |
| **L3 缓存** | 2-20MB | **最多 38 周期** | **最多 ~12.7ns** | 共享，分片连接到 ring-bus，延迟取决于缓存大小和 ring-bus 跳数 |
| **主内存（本地）** | - | **~195 周期** | **~65ns** | 平均延迟，实际变化很大（行缓冲命中更快，刷新冲突更慢） |
| **主内存（远程 NUMA）** | - | **~315 周期** | **~105ns** | 跨 socket 访问，额外 ~40ns QPI 总线延迟 |

### 内存子系统细节

| 组件 | 规格 | 说明 |
|------|------|------|
| **Memory Ordering Buffer (MOB)** | 64-entry 加载缓冲 + 36-entry 存储缓冲 | 跟踪乱序执行的内存操作，用于内存模型一致性 |
| **存储缓冲** | 36 条目，全关联队列 | 可搜索已排队的存储操作，等待 L1 缓存 |
| **L3 缓存结构** | 2MB 分片，ring-bus 连接 | 地址哈希到分片以提高吞吐量，每个 ring-bus 跳增加 1 周期 |
| **内存通道** | 4 通道聚合 | 每个 socket 4 个独立通道，通过流水线隐藏延迟 |
| **QPI 总线（Sandy Bridge）** | 8.0 GT/s，双通道聚合 | 比 Westmere/Nehalem（6.4 GT/s，单通道）快，支持预取转发 |

### NUMA 延迟对比（Sandy Bridge vs 前代）

| 架构 | QPI 速度 | QPI 带宽 vs 本地内存 | 说明 |
|------|---------|---------------------|------|
| **Sandy Bridge** | 8.0 GT/s，双通道 | 接近本地内存带宽 | 消除了前代的瓶颈 |
| **Westmere/Nehalem** | 6.4 GT/s，单通道 | 仅 ~40% 本地内存带宽 | 远程内存访问成为瓶颈 |

**测试环境说明**：
- **CPU 架构**: Intel Sandy Bridge（2011年发布）
- **数据来源**: Martin Thompson 的博客和演讲中对 Sandy Bridge 架构的详细分析

---

## 参考4：Cilium eBPF 网络转发延迟数据

**数据来源**: [Cilium eBPF 性能基准测试](https://cilium.io/blog/2021/05/11/cni-benchmark/)

| 场景 | 延迟 | 3GHz时钟周期 | 说明 |
|------|------|-------------|------|
| **Cilium eBPF 转发** (同节点) | **5-50μs** | **15K-150K周期** | 绕过内核，用户空间处理 |
| **Cilium eBPF 转发** (跨AZ) | **~0.55ms RTT** | **~1.65M周期** | 往返时间（Round Trip Time） |

**测试环境**: CNI 性能基准测试

---

## 参考5：存储设备延迟数据

**数据来源**: 
- [三星 SSD 白皮书](https://semiconductor.samsung.com/resources/white-paper/Samsung_SSD_White_Paper.pdf)
- [SNIA SSD 性能指南](https://www.snia.org/sites/default/files/SNIASSSI.SSDPerformance-APrimer2013.pdf)
- Seagate 技术文档
- Intel 白皮书

| 设备类型 | 操作类型 | 延迟 | 3GHz时钟周期 | 说明 |
|---------|---------|------|-------------|------|
| **HDD (7200 RPM)** | 随机读取 | **8-15ms** | **24M-45M周期** | 寻道时间 + 旋转延迟（平均 4.17ms） |
| **HDD (15000 RPM)** | 随机读取 | **~2ms** | **~6M周期** | 企业级硬盘，平均延迟 |
| **SATA SSD** | 随机读取 | **0.1-0.5ms** | **300K-1.5M周期** | 典型访问延迟 |
| **NVMe SSD** | 随机读取 | **20-100μs** | **60K-300K周期** | 高端型号可低至 20μs |
| **NVMe SSD (高端)** | 随机读取 | **~20μs** | **~60K周期** | PCIe 4.0, 低延迟型号 |

**说明**：
- HDD 延迟计算：7200 RPM 平均旋转延迟 = 60s / (7200/2) = 4.17ms，加上寻道时间约 9ms，总计约 8-15ms
- SSD 延迟因接口类型（SATA/NVMe）、主控芯片、NAND 类型而异
- 实际性能会因具体型号、工作负载、测试环境而有所不同

---

## 参考6：RDMA 网络延迟数据

**数据来源**: 
- [Apache Hadoop RDMA性能测试：IB与RoCE网络环境对比研究](https://blog.csdn.net/gitblog_00546/article/details/151340331)
- [中国移动研究院《以太无损网络测试方法学》](https://13115299.s21i.faiusr.com/61/1/ABUIABA9GAAg_pSVjgYo086Y-gE.pdf)
- RDMA技术研究论文和性能测试报告

| 网络类型 | 场景 | 延迟 | 3GHz时钟周期 | 说明 |
|---------|------|------|-------------|------|
| **InfiniBand (IB)** | 单流往返延迟 (4KB消息) | **~2.3μs** | **~6.9K周期** | 高性能计算场景 |
| **InfiniBand (IB)** | 10并发流延迟 | **~2.8μs** | **~8.4K周期** | 多流并发场景 |
| **InfiniBand (IB)** | 100并发流延迟 | **~12.5μs** | **~37.5K周期** | 高并发场景 |
| **RoCE (RDMA over Ethernet)** | 单流往返延迟 (4KB消息) | **~3.1μs** | **~9.3K周期** | 基于以太网的RDMA |
| **RoCE** | 10并发流延迟 | **~4.5μs** | **~13.5K周期** | 多流并发场景 |
| **RoCE** | 100并发流延迟 | **~28.3μs** | **~85K周期** | 高并发场景 |
| **RDMA (高端网卡)** | 单向延迟 (无拥塞) | **< 1μs** | **< 3K周期** | 理想条件下，某些高性能网卡可达 |
| **传统 TCP/IP** | 同机房网络延迟 | **100-200μs** | **300K-600K周期** | 需要经过物理网卡、交换机等网络设备 |
| **传统 TCP/IP** | 跨网络延迟 | **200-500μs** | **600K-1.5M周期** | 包含路由、拥塞控制等开销 |

**说明**：
- InfiniBand (IB) 是专用的高性能网络技术，延迟最低
- RoCE (RDMA over Converged Ethernet) 在以太网上实现RDMA，延迟略高于IB但部署更灵活
- RDMA通过内核旁路和零拷贝机制显著降低延迟，相比传统TCP/IP可降低10-50倍
- 实际延迟会因硬件配置、网络环境、消息大小、并发度等因素而有所差异
- 传统TCP/IP需要操作系统内核介入，引入系统调用、上下文切换、多次内存拷贝等开销

---

## 参考7：Loopback TCP/UDP 延迟数据

**数据来源**: 
- [Man Group: 基于 Aeron 的高性能、低延迟执行系统性能测试](https://www.man.com/special-fx-execution-system-on-aeron)
- [UNSW 虚拟机性能测试：Loopback TCP/UDP 延迟](https://cgi.cse.unsw.edu.au/~cs9242/10/lectures/06-virt.pdf)

| 传输方式 | 场景 | 延迟 | 3GHz时钟周期 | 说明 |
|---------|------|------|-------------|------|
| **Aeron IPC** | 往返延迟 (RTT) | **~0.25μs** | **~750周期** | 共享内存进程间通信 |
| **UDP (loopback)** | 往返延迟 (RTT) | **5-10μs** | **15K-30K周期** | 标准UDP loopback，不经过物理网络 |
| **TCP (loopback)** | 往返延迟 (RTT) | **10-20μs** | **30K-60K周期** | 标准TCP loopback，包含连接管理开销 |
| **Aeron UDP (loopback)** | 往返延迟 (RTT) | **~10μs** | **~30K周期** | 优化的UDP实现，同一台机器上 |
| **UDP (同机房)** | 往返延迟 (RTT) | **50-150μs** | **150K-450K周期** | 同机房网络，经过物理网卡和交换机 |
| **TCP (同机房)** | 往返延迟 (RTT) | **100-200μs** | **300K-600K周期** | 同机房网络，包含TCP协议开销 |

**说明**：
- Loopback（127.0.0.1）通信不经过物理网络硬件，延迟主要来自操作系统网络栈处理，延迟最低
- 同机房网络需要经过物理网卡、交换机等网络设备，延迟明显高于loopback
- Aeron IPC 使用共享内存，延迟最低，接近内存访问延迟
- Aeron UDP 通过优化的UDP实现，延迟低于标准UDP
- TCP 由于需要连接管理、可靠性保证、流量控制等机制，延迟高于UDP
- 实际延迟会因操作系统、硬件配置、系统负载、消息大小、网络设备等因素而有所差异

---

**版本**：2.0  
**最后更新**：2025-01-02  
**维护者**：Exchange-CPP Team


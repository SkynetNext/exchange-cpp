# æŠ€æœ¯ç¬”è®°

## ä¸€ã€é«˜æ€§èƒ½è®¾è®¡æ€è·¯ (C++)

### 1.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | è¾¾æˆ | è¡Œä¸šæ ‡å‡† | å€æ•° |
|------|------|----------|------|
| **P50 å»¶è¿Ÿ** | 0.49-0.82Âµs | < 1Âµs | âœ… è¶…è¶Š |
| **P99 å»¶è¿Ÿ** | 0.73-1.6Âµs | < 5Âµs | âœ… 3x+ |
| **P99.9 å»¶è¿Ÿ** | 5.8-18Âµs | < 20Âµs | âœ… è¶…è¶Š |
| **ååé‡** | 9M TPS | 1M TPS | âœ… 9x |

### 1.2 å…³é”®è®¾è®¡å†³ç­–

#### Lock-Free æ¶æ„
- **Disruptor æ¨¡å¼**: å• Ring Buffer + Sequence Barrier å®ç°æ— é”æµæ°´çº¿
- **é¿å…äº’æ–¥é”**: MPSC ä½¿ç”¨ `fetch_add` + `acq_rel` (x86: `lock xadd`) åŸå­è·å– sequenceï¼Œæ¶ˆé™¤é”ç«äº‰
- **å¤šç”Ÿäº§è€…æ”¯æŒ**: `MultiProducerRingBuffer` å¤„ç†å¤š Gateway çº¿ç¨‹å¹¶å‘å†™å…¥

#### é›¶åˆ†é…çƒ­è·¯å¾„
- **å¯¹è±¡é¢„åˆ†é…**: Ring Buffer å¯åŠ¨æ—¶åˆ†é…æ‰€æœ‰ `OrderCommand`
- **å¯¹è±¡æ± **: è‡ªå®šä¹‰ `ObjectsPool` å¤ç”¨ ART Nodeã€Order å¯¹è±¡
- **mimalloc**: å…¨å±€æ›¿æ¢åˆ†é…å™¨ï¼Œå‡å°‘ 50%+ åˆ†é…å¼€é”€

#### æ•°æ®ç»“æ„ä¼˜åŒ–
| åœºæ™¯ | é€‰å‹ | åŸå›  |
|------|------|------|
| ä»·æ ¼ç´¢å¼• | ART Tree | O(k) å¸¸æ•°æ—¶é—´ï¼Œ3-5x ä¼˜äº `std::map` |
| HashMap | `ankerl::unordered_dense` | 1.5-2.5x ä¼˜äº `std::unordered_map` (å®æµ‹) |
| è®¢å•é“¾è¡¨ | Intrusive Linked List | é›¶é¢å¤–å†…å­˜åˆ†é… |
| å¹¶å‘é˜Ÿåˆ— | `moodycamel::ConcurrentQueue` | 14ns å»¶è¿Ÿï¼Œ70M ops/s |

#### Memory Order ä¼˜åŒ–
- **é¿å… seq_cst**: `xchg` æŒ‡ä»¤éšå« lock å‰ç¼€ï¼Œ5-10ns å¼€é”€
- **x86-64 TSO æ¨¡å‹**: acquire load ç¼–è¯‘ä¸ºæ™®é€š `mov`ï¼Œæ— é¢å¤–å±éšœ
- **Acquire-Release è¶³å¤Ÿ**: ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼æ— éœ€å…¨åº

### 1.3 æµæ°´çº¿å¹¶è¡Œè®¾è®¡

```
Gateway â†’ Grouping â†’ Risk(R1) â†’ Matching â†’ Risk(R2) â†’ Results
                  â†˜ Journaling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†—
```

- **åˆ†ç»„æœºåˆ¶**: æ¯ N æ¡æ¶ˆæ¯åˆ›å»º Groupï¼Œå…è®¸ R1 æå‰ publish Sequence
- **Two-Step Processor**: Master æ£€æµ‹è¾¹ç•Œ â†’ Slave å¤„ç† â†’ ä¸‹æ¸¸æå‰å¯åŠ¨
- **å¹¶è¡Œè·¯å¾„**: Journaling ä¸ Trading Chain å¹¶è¡Œæ‰§è¡Œ

---

## äºŒã€ä»£ç ä¼˜åŒ–ç»†èŠ‚

### 2.1 çƒ­è·¯å¾„è¯†åˆ«ä¸ä¼˜åŒ–

| é—®é¢˜ | ä½ç½® | ä»£ä»· | çŠ¶æ€ |
|------|------|------|------|
| Virtual Function | `IOrderBook` | 10-20ns/call | è€ƒè™‘ CRTP |
| Exception Handling | `TwoStepMasterProcessor` | 1.7-3.3Âµs | å·²å¯¹é½ Java |
| Hash Lookup | `orderIdIndex_` | - | ART â†’ unordered_dense |

### 2.2 å…³é”®ä¼˜åŒ–æ¡ˆä¾‹

**orderIdIndex_ ä¼˜åŒ– (2026-01-16)**
- Before: ART Tree (æ ‘æŸ¥æ‰¾)
- After: `ankerl::unordered_dense::map` (O(1) å“ˆå¸Œ)
- Result: P50 @ 6M TPS è¶…è¶Š Java ç‰ˆæœ¬

### 2.3 CPU äº²å’Œæ€§
- æ¯ä¸ª Processor ç»‘å®šç‹¬ç«‹ CPU æ ¸å¿ƒ
- `AffinityThreadFactory` è®¾ç½®çº¿ç¨‹äº²å’Œæ€§
- é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç¼“å­˜å¤±æ•ˆ

---

## ä¸‰ã€å·¥ç¨‹èƒ½åŠ›ä¸æ–¹æ³•è®º

### 3.1 ä»£ç è´¨é‡ä¿è¯

| ç»´åº¦ | å®è·µ |
|------|------|
| **ç¼–è¯‘è­¦å‘Š** | `-Wall -Wextra -Werror`ï¼Œé›¶è­¦å‘Šç­–ç•¥ |
| **é™æ€åˆ†æ** | clang-tidy + cppcheck |
| **å•å…ƒæµ‹è¯•** | GoogleTestï¼Œè¦†ç›–æ ¸å¿ƒæ•°æ®ç»“æ„ |
| **é›†æˆæµ‹è¯•** | å®Œæ•´è®¢å•ç”Ÿå‘½å‘¨æœŸæµ‹è¯• |
| **æ€§èƒ½æµ‹è¯•** | `TestLatencyMargin` åŸºå‡†æµ‹è¯• |

### 3.2 Code Review å…³æ³¨ç‚¹

1. **å†…å­˜å®‰å…¨**: æ‰€æœ‰æƒæ¸…æ™°ã€é¿å… use-after-free
2. **å¹¶å‘æ­£ç¡®æ€§**: Memory Order ä½¿ç”¨æ˜¯å¦æ­£ç¡®
3. **çƒ­è·¯å¾„å½±å“**: æ˜¯å¦å¼•å…¥åˆ†é…ã€å¼‚å¸¸ã€è™šå‡½æ•°
4. **API å…¼å®¹æ€§**: æ˜¯å¦ä¿æŒä¸ Java ç‰ˆæœ¬è¡Œä¸ºä¸€è‡´

### 3.3 æ¶æ„æ–‡æ¡£åŒ–

- `ARCHITECTURE.md`: Sequence/Barrier å®Œæ•´æµç¨‹
- `LOW_LATENCY_CORE.md`: æ€§èƒ½æŒ‡æ ‡ä¸å¯¹æ¯”
- `HOT_PATH_PERFORMANCE_TODO.md`: å¾…ä¼˜åŒ–æ¸…å•
- `guides/`: å†…å­˜åºã€ART æ ‘ç­‰æ·±åº¦æŠ€æœ¯æ–‡æ¡£

---

## å››ã€C++ ç°ä»£åŒ–æ¼”è¿›

### 4.1 C++23ï¼šç¨³å®šä¸æ‰“ç£¨

C++23 æ˜¯"æ‰“ç£¨ç‰ˆ"å‘å¸ƒï¼Œç¨³å®š C++20 ä¸»è¦ç‰¹æ€§ï¼Œä¸ºåº“ä½œè€…å’Œç³»ç»Ÿå¼€å‘è€…æä¾›å®ç”¨æ”¹è¿›ã€‚

#### è¯­è¨€ç‰¹æ€§

| ç‰¹æ€§ | å·¥ç¨‹ä»·å€¼ | æœ¬é¡¹ç›®åº”ç”¨ |
|------|----------|------------|
| **Deducing `this`** | ç®€åŒ– CRTPï¼Œå‡å°‘ 50%+ æ¨¡æ¿æ ·æ¿ä»£ç  | é™æ€å¤šæ€åœºæ™¯ |
| **`if consteval`** | `constexpr` å‡½æ•°å†…åˆ¤æ–­ç¼–è¯‘æœŸ/è¿è¡ŒæœŸï¼Œé€‰æ‹©ä¸åŒç®—æ³• | é…ç½®é¢„è®¡ç®— |

**Deducing `this` ç®€åŒ– CRTP**ï¼š
```cpp
// ä¼ ç»Ÿ CRTP (C++20)ï¼šéœ€è¦æ¨¡æ¿å‚æ•° + static_cast
template<typename Derived>
struct Base {
    void interface() {
        static_cast<Derived*>(this)->impl();
    }
};
struct Derived : Base<Derived> { void impl() { /*...*/ } };

// Deducing this (C++23)ï¼šè‡ªåŠ¨æ¨å¯¼ï¼Œæ— éœ€æ¨¡æ¿å’Œè½¬å‹
struct Base {
    void interface(this auto&& self) {
        self.impl();
    }
};
struct Derived : Base { void impl() { /*...*/ } };
```
| **`constexpr` æ‰©å±•** | æ›´å¤šå®¹å™¨/ç®—æ³•ç¼–è¯‘æœŸå¯ç”¨ | å¸¸é‡é…ç½®æ ¡éªŒ |
| **`std::print`** | ç±»å‹å®‰å…¨æ ¼å¼åŒ–è¾“å‡ºï¼Œæ›¿ä»£ `printf`/`iostream` | æ—¥å¿—è¾“å‡º |

**`if consteval` ç¤ºä¾‹**ï¼š
```cpp
constexpr uint64_t ipow(uint64_t base, uint8_t exp) {
    if consteval {
        // ç¼–è¯‘æœŸï¼šç”¨æ•´æ•°å¾ªç¯ç®—æ³•
        uint64_t res = 1;
        while (exp--) res *= base;
        return res;
    } else {
        // è¿è¡ŒæœŸï¼šç”¨ç¡¬ä»¶ä¼˜åŒ–çš„ std::pow
        return std::pow(base, exp);
    }
}
```

#### æ ‡å‡†åº“ç‰¹æ€§

| ç‰¹æ€§ | å·¥ç¨‹ä»·å€¼ | æœ¬é¡¹ç›®åº”ç”¨ |
|------|----------|------------|
| **`std::expected<T, E>`** | é›¶å¼€é”€é”™è¯¯å¤„ç†ï¼Œæ›¿ä»£å¼‚å¸¸ | çƒ­è·¯å¾„è¿”å›å€¼ |
| **`std::mdspan`** | å¤šç»´æ•°ç»„è§†å›¾ | å¸‚åœºæ•°æ®å¤„ç† |
| **`std::flat_map`** | ç¼“å­˜å‹å¥½æœ‰åºå®¹å™¨ | âš ï¸ **ä»…é€‚åˆåªè¯»æˆ–æ‰¹é‡æ„å»º**ï¼Œéšæœºæ’å…¥ O(N) |

**`std::flat_map` æ³¨æ„äº‹é¡¹**ï¼š
```cpp
// âŒ é”™è¯¯ç”¨æ³•ï¼šéšæœºæ’å…¥ O(NÂ²)ï¼Œå¤§æ•°æ®é›†ä¼šå¡æ­»
std::flat_map<int, int> fm;
for (int i : random_keys) fm[i] = i;  // æ¯æ¬¡æ’å…¥éƒ½è¦ç§»åŠ¨å…ƒç´ 

// âœ… æ­£ç¡®ç”¨æ³•ï¼šæ‰¹é‡æ„å»ºååªè¯»æŸ¥è¯¢
std::vector<std::pair<int, int>> data = ...;
std::ranges::sort(data);
std::flat_map<int, int> fm(std::from_range, data);  // O(1) æŸ¥è¯¢ï¼Œç¼“å­˜å‹å¥½
```

#### ç¼–è¯‘å™¨æ”¯æŒ

| ç‰¹æ€§ | GCC | Clang | MSVC |
|------|-----|-------|------|
| `deducing this` | 14+ | 18+ | 19.32+ |
| `if consteval` | 12+ | 14+ | 19.31+ |
| `std::expected` | 12+ | 16+ | 19.33+ |
| `std::print` | 14+ | 18+ | 19.37+ |

---

### 4.2 C++26ï¼šç¬¬äºŒæ³¢ç°ä»£åŒ–

C++26 è¢«è§†ä¸ºç»§ C++11 åçš„é‡å¤§è¿›åŒ–ã€‚éƒ¨åˆ†åº“ç‰¹æ€§å·²æœ‰ç”Ÿäº§éªŒè¯ï¼ˆå¦‚ `folly::hazard_pointer`ï¼‰ã€‚

#### å·²ç¡®è®¤ç‰¹æ€§ï¼ˆcppreference æ”¶å½•ï¼‰

**å®¹å™¨**ï¼š

| ç‰¹æ€§ | å·¥ç¨‹ä»·å€¼ | æœ¬é¡¹ç›®åº”ç”¨ |
|------|----------|------------|
| **`std::inplace_vector<T, N>`** | å›ºå®šå®¹é‡æ ˆåˆ†é…ï¼Œé›¶å †åˆ†é… | åºåˆ—åŒ–ç¼“å†²åŒº (< 256B) |
| **`std::hive`** | ç¨³å®šæŒ‡é’ˆã€è‡ªåŠ¨å†…å­˜é‡ç”¨ | å¯¹è±¡æ± æ›¿ä»£æ–¹æ¡ˆ |

```cpp
// std::inplace_vectorï¼šå°æ•°æ®é›¶å †åˆ†é…
std::inplace_vector<uint8_t, 256> buf;
buf.resize(100);  // æ ˆåˆ†é…ï¼Œé›¶å»¶è¿Ÿ

// std::hiveï¼šç¨³å®šæŒ‡é’ˆ
std::hive<Order> orders;
auto it = orders.insert(order);
orders.erase(other_it);  // it ä»ç„¶æœ‰æ•ˆ
```

**å¹¶å‘**ï¼š

| ç‰¹æ€§ | å·¥ç¨‹ä»·å€¼ | æœ¬é¡¹ç›®åº”ç”¨ |
|------|----------|------------|
| **`std::execution`** (P2300) | æ ‡å‡†åŒ–å¼‚æ­¥æ‰§è¡Œæ¡†æ¶ | å·²æœ‰ Disruptorï¼Œæš‚ä¸éœ€è¦ |
| **`std::hazard_pointer`** | æ— é”æ•°æ®ç»“æ„ ABA é—®é¢˜è§£å†³ | Disruptor å·²å†…éƒ¨å¤„ç†ï¼ŒæŒ‰éœ€ä½¿ç”¨ |
| **`std::rcu`** | è¯»å¤šå†™å°‘åœºæ™¯ | é…ç½®çƒ­æ›´æ–° |

**è¯­è¨€**ï¼š

| ç‰¹æ€§ | å·¥ç¨‹ä»·å€¼ | ç¼–è¯‘å™¨æ”¯æŒ |
|------|----------|------------|
| **Contracts** (P2900R14) | å‰ç½®/åç½®æ¡ä»¶æ£€æŸ¥ | âŒ æ— ä¸»æµç¼–è¯‘å™¨æ”¯æŒ |
| **`constexpr` å¼‚å¸¸** (P3068R6) | ç¼–è¯‘æœŸå¼‚å¸¸å¤„ç† | âŒ æ— ä¸»æµç¼–è¯‘å™¨æ”¯æŒ |
| **Pack indexing** (P2662R3) | `T...[I]` è¯­æ³•è®¿é—®å‚æ•°åŒ… | GCC 15+, Clang 19+ |

#### Reflection (P2996)

| çŠ¶æ€ | ç¼–è¯‘å™¨æ”¯æŒ |
|------|------------|
| âš ï¸ æœªåˆ—å…¥ cppreference C++26ï¼Œä½†å·²æœ‰å®éªŒæ€§æ”¯æŒ | GCC 14+ `-freflection`, Clang (p2996 fork) |

**å®é™…åº”ç”¨**ï¼šå·²ç”¨äº JSON è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼ˆè§ `JsonReflection.h`ï¼‰

```cpp
// C++26 åå°„è‡ªåŠ¨ç”Ÿæˆ JSON è§£æ
template <typename T>
void from_json_auto(const nlohmann::json& j, T& obj) {
    template for (const auto member : ^^T.nonstatic_data_members) {
        constexpr auto member_name = [:member.name():];
        using member_type = [:member.type():];
        if (j.contains(member_name)) {
            obj.[:member:] = j[member_name].get<member_type>();
        }
    }
}
```

**ç¼–è¯‘è¦æ±‚**ï¼š`-std=c++26 -freflection` (GCC 14+)

#### ç¼–è¯‘å™¨æ”¯æŒç°çŠ¶ï¼ˆ2026-01ï¼‰

| ç‰¹æ€§ | GCC | Clang | MSVC |
|------|-----|-------|------|
| `std::inplace_vector` | âŒ | âŒ | âŒ |
| `std::hive` | âŒ | âŒ | âŒ |
| `std::execution` | âŒ | âŒ | âŒ |
| Contracts | âŒ | âŒ | âŒ |

*æ³¨ï¼šC++26 åº“ç‰¹æ€§å°šæ— ä¸»æµç¼–è¯‘å™¨å®ç°ï¼Œè¯­è¨€ç‰¹æ€§éƒ¨åˆ†å·²æœ‰æ”¯æŒã€‚*

---

### 4.3 æœ¬é¡¹ç›®åº”ç”¨ç­–ç•¥

| ä¼˜å…ˆçº§ | ç‰¹æ€§ | è¡ŒåŠ¨ |
|--------|------|------|
| ğŸ”¥ **ç«‹å³å¯ç”¨** | `std::expected`, `std::print`, `if consteval` | é€æ­¥æ›¿æ¢å¼‚å¸¸å¤„ç†å’Œæ—¥å¿— |
| âœ… **å·²åœ¨ä½¿ç”¨** | Reflection (P2996) | JSON è‡ªåŠ¨åºåˆ—åŒ– (`-freflection`) |
| ğŸ“‹ **è·Ÿè¸ªå…³æ³¨** | `std::inplace_vector`, Contracts | ç¼–è¯‘å™¨æ”¯æŒåè¯„ä¼°å¼•å…¥ |
| ğŸ” **æŒ‰éœ€è¯„ä¼°** | `std::hive`, `std::execution` | å·²æœ‰ ObjectsPool/Disruptorï¼Œéåˆšéœ€ |
| â¸ï¸ **æš‚ä¸è€ƒè™‘** | `std::linalg` | é¡¹ç›®ä¸æ¶‰åŠçº¿æ€§ä»£æ•° |

---

### 4.4 ä½¿ç”¨çš„å¼€æºé¡¹ç›®

| é¡¹ç›® | ç”¨é€” | æ€§èƒ½æ”¶ç›Š |
|------|------|----------|
| **disruptor-cpp** | Lock-free Ring Buffer | æ— é”æµæ°´çº¿æ ¸å¿ƒ |
| **mimalloc** | å…¨å±€å†…å­˜åˆ†é…å™¨ | å‡å°‘ 50%+ åˆ†é…å¼€é”€ |
| **ankerl::unordered_dense** | Hash Map | 2-3x å¿«äº `std::unordered_map` |
| **moodycamel::ConcurrentQueue** | å¹¶å‘é˜Ÿåˆ— | 14ns å»¶è¿Ÿï¼Œ70M ops/s |
| **oneTBB** | `concurrent_hash_map` | Lock-free å¹¶å‘å“ˆå¸Œè¡¨ |
| **lz4** | å‹ç¼© | å¿«é€Ÿå‹ç¼©/è§£å‹ |

### 4.5 å…³æ³¨çš„å¼€æºé¡¹ç›®

| é¡¹ç›® | å…³æ³¨ç‚¹ |
|------|--------|
| **LMAX Disruptor** | å‚è€ƒæ¶æ„ï¼Œæœ¬é¡¹ç›® C++ å®ç°å¯¹æ ‡ |
| **Boost.Decimal** | å®šç‚¹æ•°/åè¿›åˆ¶ç®—æœ¯ï¼Œ`sqrt` ä¼˜åŒ–è´¡çŒ®ä¸­ (cppalliance/decimal#1311) |

### 4.6 å®è´¨æ€§è¡ŒåŠ¨

1. **å®Œæ•´ç¿»è¯‘** exchange-core Java â†’ C++ï¼Œå« ART Treeã€ObjectsPool
2. **æ€§èƒ½è°ƒä¼˜**: é€šè¿‡ perf + flamegraph å®šä½ç“¶é¢ˆï¼Œä¼˜åŒ– `orderIdIndex_`
3. **æ–‡æ¡£è¾“å‡º**: æ’°å†™ Memory Order æ€§èƒ½åˆ†æã€ART æ ‘æ·±åº¦æ•™ç¨‹
4. **åŸºå‡†æµ‹è¯•**: å»ºç«‹ CI æ€§èƒ½å›å½’æµ‹è¯•ï¼Œé˜²æ­¢æ€§èƒ½é€€åŒ–

---

## äº”ã€ä¸šåŠ¡ç†è§£ä¸æƒ³æ³•

### 5.1 æ’®åˆå¼•æ“æ ¸å¿ƒæŒ‘æˆ˜

- **å…¬å¹³æ€§**: ä¸¥æ ¼ä»·æ ¼-æ—¶é—´ä¼˜å…ˆçº§ (Price-Time Priority)
- **ç¡®å®šæ€§**: ç›¸åŒè¾“å…¥ â†’ ç›¸åŒå†…å­˜çŠ¶æ€ (Deterministic)
- **å®¹é”™**: Journaling + Snapshot æ”¯æŒçŠ¶æ€æ¢å¤

### 5.2 å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘

1. **FPGA å¸è½½**: ç½‘ç»œè§£æã€é£æ§å‰ç½®æ£€æŸ¥ç¡¬ä»¶åŠ é€Ÿ
2. **DPDK ç½‘ç»œæ ˆ**: ç»•è¿‡å†…æ ¸ï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿ
3. **æŒä¹…åŒ–å†…å­˜ (PMem)**: Journaling ç›´æ¥å†™ PMemï¼Œé™ä½ I/O å»¶è¿Ÿ

### 5.3 æ‰©å±•æ€è€ƒ

- **å¤šå“ç§æ’®åˆ**: Symbol åˆ†ç‰‡ï¼Œæ°´å¹³æ‰©å±• Matching Engine
- **è·¨å¸‚åœºå¥—åˆ©**: å¤šäº¤æ˜“æ‰€è¡Œæƒ…èšåˆã€ä½å»¶è¿Ÿè·¯ç”±
- **é£æ§å‡çº§**: å®æ—¶ç›¯å¸‚ã€å¼‚å¸¸è®¢å•æ£€æµ‹

---

## å…­ã€æŠ€æœ¯è®¨è®ºè¦ç‚¹

1. **é‡åŒ–è¡¨è¾¾**: P50=0.5Âµsã€9M TPSã€1.5-5x æ€§èƒ½æå‡
2. **æƒè¡¡æ€ç»´**: ä¸ºä»€ä¹ˆé€‰ ART ä¸é€‰ B+ Treeï¼Ÿä¸ºä»€ä¹ˆç”¨ Disruptorï¼Ÿ
3. **å»¶ä¼¸æ€è€ƒ**: è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘ï¼ˆCRTPã€FPGA ç­‰ï¼‰
4. **å·¥ç¨‹é—­ç¯**: è®¾è®¡ â†’ å®ç° â†’ æµ‹è¯• â†’ ç›‘æ§çš„å®Œæ•´æ€è·¯

---

**Last Updated**: 2026-01-20
